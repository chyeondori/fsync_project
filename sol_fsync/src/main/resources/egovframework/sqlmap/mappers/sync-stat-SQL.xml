<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fsync.business.stat.mapper.SyncStatMapper">

	<select id="getTopDirList" resultType ="fsync.business.stat.vo.TopDirVO">
		/* SyncStatMapper.getTopDirList */
		-- 최상위 디렉터리 목록 조회 ㅇ
		SELECT TB_TOP_DIR_INFO.SYNC_ID, TB_TOP_DIR_INFO.SRC_TOP_DIR, TB_TOP_DIR_INFO.DST_TOP_DIR, TB_DIR_INFO.DIR_ID
		FROM TB_TOP_DIR_INFO JOIN TB_DIR_INFO ON TB_TOP_DIR_INFO.SYNC_ID = TB_DIR_INFO.SYNC_ID WHERE TB_DIR_INFO.P_DIR_ID IS NULL;
	</select>

	<select id="getTopAllDirStatList" resultType ="fsync.business.stat.vo.SyncStatusVO">
		/* SyncStatMapper.getTopAllDirStatList */
		-- 최상위 모든 디렉터리 현황 조회 ㅇ
		SELECT
			TB_DIR_INFO.DIR_ID,
			TB_DIR_INFO.P_DIR_ID,
			TB_TOP_DIR_INFO.SYNC_ID,
			TB_DIR_INFO.C_DIR_NM,
			TB_DIR_INFO.SRC_F_DIR_NM,
			TB_DIR_INFO.TOT_FILE_SIZE,
			TB_DIR_INFO.TOT_FILE_CNT,
			CONCAT(TB_TOP_DIR_INFO.DST_TOP_DIR, SUBSTRING(TB_DIR_INFO.SRC_F_DIR_NM, LENGTH(TB_TOP_DIR_INFO.SRC_TOP_DIR)+1)) AS SYNCD_DIR_NM,
			TB_DIR_INFO.SYNCD_FILE_SIZE,
			TB_DIR_INFO.SYNCD_FILE_CNT,
			IFNULL(CONCAT(TB_DIR_INFO.SYNCD_FILE_SIZE DIV TB_DIR_INFO.TOT_FILE_SIZE, '%'), '0%') AS PROGRESSING,
			TB_CMMN_CD.CD_NM AS PROC_STAT,
			TB_DIR_INFO.PROC_DTM
		FROM TB_DIR_INFO
		    JOIN TB_TOP_DIR_INFO ON TB_DIR_INFO.SYNC_ID = TB_TOP_DIR_INFO.SYNC_ID
			JOIN TB_CMMN_CD ON TB_DIR_INFO.PROC_STAT = TB_CMMN_CD.CD AND TB_CMMN_CD.GROUP_CD = '1'
		WHERE P_DIR_ID IS NULL;
	</select>

	<select id="getAllDirList" resultType="fsync.business.stat.vo.SyncStatusVO">
		/* SyncStatMapper.getAllDirList */
		-- 디렉터리 전체 파일 현황 조회 ㅇ by mjh
		(SELECT
			 TB_DIR_INFO.DIR_ID,
			 TB_DIR_INFO.P_DIR_ID,
			 TB_TOP_DIR_INFO.SYNC_ID,
			 TB_DIR_INFO.C_DIR_NM,
			 TB_DIR_INFO.SRC_F_DIR_NM,
			 TB_DIR_INFO.TOT_FILE_SIZE,
			 TB_DIR_INFO.TOT_FILE_CNT,
			 CONCAT(TB_TOP_DIR_INFO.DST_TOP_DIR, SUBSTRING(TB_DIR_INFO.SRC_F_DIR_NM, LENGTH(TB_TOP_DIR_INFO.SRC_TOP_DIR)+1)) AS SYNCD_DIR_NM,
			 TB_DIR_INFO.SYNCD_FILE_SIZE,
			 TB_DIR_INFO.SYNCD_FILE_CNT,
			 IFNULL(CONCAT(TB_DIR_INFO.SYNCD_FILE_SIZE DIV TB_DIR_INFO.TOT_FILE_SIZE, '%'), '0%') AS PROGRESSING,
			 TB_CMMN_CD.CD_NM AS PROC_STAT,
			 TB_DIR_INFO.PROC_DTM,
			 NULL AS FILE_TYPE_CD
		 FROM TB_DIR_INFO JOIN TB_TOP_DIR_INFO ON TB_DIR_INFO.SYNC_ID = TB_TOP_DIR_INFO.SYNC_ID
						  JOIN TB_CMMN_CD ON TB_DIR_INFO.PROC_STAT = TB_CMMN_CD.CD AND TB_CMMN_CD.GROUP_CD = '1'
		 WHERE P_DIR_ID = #{pDirId})

		UNION

		(SELECT
			 TB_FILE_INFO.FILE_ID AS DIR_ID,
			 TB_FILE_INFO.DIR_ID AS P_DIR_ID,
			 TB_TOP_DIR_INFO.SYNC_ID,
			 TB_FILE_INFO.FILE_NM AS C_DIR_NM,
			 CONCAT(TB_FILE_INFO.SRC_F_PATH_NM, '/', TB_FILE_INFO.FILE_NM) AS SRC_F_DIR_NM,
			 TB_FILE_INFO.FILE_SIZE AS TOT_FILE_SIZE,
			 1 AS TOT_FILE_CNT,
			 CONCAT(TB_TOP_DIR_INFO.DST_TOP_DIR, SUBSTRING(TB_FILE_INFO.SRC_F_PATH_NM, LENGTH(TB_TOP_DIR_INFO.SRC_TOP_DIR)+1), '/', TB_FILE_INFO.FILE_NM) AS SYNCD_DIR_NM,
			 IF(TB_FILE_INFO.PROC_STAT='FO', TB_FILE_INFO.FILE_SIZE, 0) AS SYNCD_FILE_SIZE,
			 IF(TB_FILE_INFO.PROC_STAT='FO', 1, 0) AS  SYNCD_FILE_CNT,
			 IF(TB_FILE_INFO.PROC_STAT='FO', '100%', '0%') AS PROGRESSING,
			 TB_CMMN_CD.CD_NM AS PROC_STAT,
			 TB_FILE_INFO.PROC_DTM,
			 TB_FILE_INFO.FILE_TYPE_CD
		 FROM TB_FILE_INFO
				  JOIN TB_DIR_INFO ON TB_FILE_INFO.DIR_ID = TB_DIR_INFO.DIR_ID
				  JOIN TB_TOP_DIR_INFO ON TB_DIR_INFO.SYNC_ID = TB_TOP_DIR_INFO.SYNC_ID
				  JOIN TB_CMMN_CD ON TB_FILE_INFO.PROC_STAT = TB_CMMN_CD.CD AND TB_CMMN_CD.GROUP_CD = '1'
		 WHERE TB_FILE_INFO.DIR_ID = 0);
	</select>
</mapper>